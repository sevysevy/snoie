{% extends "base.html" %}
{% load i18n static %}
{% load widget_tweaks %}

{% block title %} 
    SNOIE | {% translate "Statistiques Alertes" %}
{% endblock %}


{% block content %}

<section class="content-header row">
    <div class="col-sm-6">
    <h1>Statistique Alertes/Dénonciations</h1>
    </div>
   
</section>


<section class="content">
    <input name="stat-data" value="{% url 'stat-al-datas' %}" hidden />
    <div class="row">
        <div class="col-lg-7 col-md-4">

        </div>
        <div class="col-md-8 col-lg-5 col-sm-12 form-group" 
        id="daterange" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
        <label for="daterange">Filtre : </label> 
            <i class="fa fa-calendar"></i>&nbsp;
            <span></span> <i class="fa fa-caret-down"></i>
        </div>
    </div>
    <div class="row">

    
        <div class="col-3">

            <div class="card ">
                <div class="top"></div>
                <div class="card-body stats-alert">
                    <p class="title">Total d'alertes</p>
                    <p class="num" id="num">{{num_alerts}}</p>
                </div>
            </div>

        </div>
        <div class="col-9">
            <div class="card card-light">
                <div class="card-header">
                    <h3 class="card-title">
                        Statistique des alertes par mois 
                    </h3>
                </div>
                <div class="card-body">
                    <div class="card-body">
                        {{alerts_by_months}}
                        <canvas id="donutChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- -->
    <div class="row">
        <div class="col-6">
            <div class="card card-success">
                <div class="card-header">
                    <h3 class="card-title">
                        Canaux   
                    </h3>
                </div>
                <div class="card-body">
                    <div class="card-body">
                        {{alerts_by_canals}}
                        <canvas id="donutChartCanal" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

            <div class="col-6">
            <div class="card card-seccess">
                <div class="card-header">
                    <h3 class="card-title">
                        Régions  
                    </h3>
                </div>
                <div class="card-body">
                    <div class="card-body">
                        {{alerts_by_regions}}
                        <canvas id="donutChartRegion" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js" defer></script>

<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />

<script src="{% static 'js/shared.js' %}"></script>



<script>
    $(document).ready(function () {

        var chartArray = []

        // Change language first 
        var datepicker_regional_fr = {
            closeText: "Fermer",
            format: "DD/MM/YYYY",
            prevText: "Précédent",
            applyLabel: "Appliquer",
            cancelLabel: "Annuler",
            nextText: "Suivant",
            currentText: "Aujourd'hui",
            customRangeLabel: "Personnaliser",
            monthNames: ["janvier", "février", "mars", "avril", "mai", "juin",
            "juillet", "août", "septembre", "octobre", "novembre", "décembre"
            ],
            monthNamesShort: ["janv.", "févr.", "mars", "avr.", "mai", "juin",
            "juil.", "août", "sept.", "oct.", "nov.", "déc."
            ],
            //daysO: ["dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi"],
            daysOfWeek: ["dim.", "lun.", "mar.", "mer.", "jeu.", "ven.", "sam."],
            dayNamesMin: ["D", "L", "M", "M", "J", "V", "S"],
            weekHeader: "Sem.",
            dateFormat: "dd/mm/yy",
            firstDay: 1,
            isRTL: false,
            showMonthAfterYear: true,
            yearSuffix: ""
        };

        var start = moment().subtract(29, 'days');
        var end = moment();

        function cb(start, end) {
            $('#daterange span').html(start.format('D MMMM YYYY') + ' - ' + end.format('D MMMM YYYY'));
            lstart = moment($('#daterange').data('daterangepicker').startDate).toDate(),
            lend = moment($('#daterange').data('daterangepicker').endDate).toDate();

            // Make a date 
            start_date = lstart.getFullYear() + "-" + (lstart.getMonth() + 1)  + "-" + lstart.getDate() ; 
            end_date =  lend.getFullYear() + "-" + (lend.getMonth() + 1) + "-" + lend.getDate() ; 

             
            //console.log(test); 
            // Send it to AJAX 

            build_graphs(start , end , chartArray)
             
        }

        $('#daterange').daterangepicker({
            locale : datepicker_regional_fr,
            startDate: start,
            endDate: end,
            ranges: {
            'Ajourd\'hui': [moment(), moment()],
            'Hier': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'Les 7 derniers jours': [moment().subtract(6, 'days'), moment()],
            'Les 30 derniers jours': [moment().subtract(29, 'days'), moment()],
            'Ce mois': [moment().startOf('month'), moment().endOf('month')],
            'Le mois dernier': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        }, cb);

        cb(start, end);

        
      
   });


   function build_graphs(start , end , chartArray){
    
        

        $.ajax({
            type: "GET",
            url: $("input[name=stat-data]").val(),
            data: {start: start_date, end : end_date},
            dataType: "JSON",
            beforeSend: function(){
                for(val in chartArray){
                    console.log(chartArray[val] )
                    chartArray[val].destroy()
                }
            },
            success: function (response) {    
                console.log(response)
                
                
                // Mise à jour des nombres                     
                document.getElementById('num').innerText = response.num_alerts ;

                //alert par mois
                var xValues = ["Janvier", "Fevrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
                var aByMonth = []
                for(var key in response.alerts_by_months){
                    aByMonth.push(response.alerts_by_months[key])
                }
                var yValues = aByMonth ;
                var barColors = "rgba(60,141,188,0.9)";

                var ChartMois = new Chart("donutChart", {
                    type: "bar",
                    data: {
                        labels: xValues,
                        datasets: [{
                            backgroundColor: barColors,
                            data: yValues, 
                            label    : 'Nombre d\'alertes'
                        }]
                    },
                    options : {
                        scales: {
                            y: {
                                max: 9,
                                min: 0, 
                                stepSize: 1

                            },
                        }
                    }
                
                });

                


                //alerts par regions

                labels = []
                aByRegions = []

                for(var key in response.alerts_by_regions){
                    labels.push(key)
                    aByRegions.push (response.alerts_by_regions[key])
                }

                var donutChartCanvas3 = $('#donutChartRegion').get(0).getContext('2d')
                var donutData3      = {
                    labels: labels,
                    datasets: [
                        {
                        data: aByRegions,
                        backgroundColor : ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#686868', '#f56004', '#30c00f', '#f40c12', '#00d0df'],
                        }
                    ]
                }
                
                var ChartRegion =  new Chart(donutChartCanvas3, {
                    type: 'pie',
                    data: donutData3,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            labels: {
                            render: 'percentage',
                            precision: 2
                            }
                        },
                    }
                })


                // by canals
                labels = []
                aByCanals = []

                for(var key in response.alerts_by_canals){
                    labels.push(key)
                    aByCanals.push (response.alerts_by_canals[key])
                }

                var donutChartCanvas2 = $('#donutChartCanal').get(0).getContext('2d')
                var donutData2      = {
                    labels: labels,
                    datasets: [
                        {
                        data: aByCanals,
                        backgroundColor : ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#686868'],
                        }
                    ]
                }
                
                //Créer des stat en forme circulaires
                // You can switch between pie and douhnut using the method below.
                var ChartCanaux = new Chart(donutChartCanvas2, {
                    type: 'pie',
                    data: donutData2
                    
                })

                
        
                chartArray.push(ChartMois , ChartRegion , ChartCanaux)

             /*   
                regdata = JSON.parse(response.regionData) ; 
                ChartRegion.data.datasets[0].data = regdata.data
                ChartRegion.update();                     


                canal = JSON.parse(response.canalData)              
                ChartCanaux.data.datasets[0].data = canal.canal
                ChartCanaux.update(); */

            }
        });

    }
</script>

{% endblock %}